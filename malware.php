<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

session_start();

if (!isset($_SESSION['email'])) {
    header('Location: blank.html');
    exit();
}

$conn = new mysqli('localhost', 'toor', 'root', 'myDatabase');

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

$email = $_SESSION['email'];

$sql = "SELECT first_name, last_name, email, analyst_level, avatar FROM users WHERE email=?";
$stmt = $conn->prepare($sql);
$stmt->bind_param('s', $email);
$stmt->execute();
$stmt->bind_result($first_name, $last_name, $email, $analyst_level, $avatar);

if (!$stmt->fetch()) {
    die("Erreur lors de la récupération des informations de l'utilisateur.");
}

$stmt->close();

function isProcessRunning($pid) {
    return file_exists("/proc/$pid");
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['malwareFamily'])) {
        // Vider les répertoires avant d'exécuter le script
        shell_exec('rm -rf /var/www/html/Downloaded/json/*');
        shell_exec('rm -rf /var/www/html/Downloaded/samples/*');
        shell_exec('rm -rf /var/www/html/csv/*');

        $malwareFamily = $_POST['malwareFamily'];
        $url = 'http://127.0.0.1:5000/malware_retrieval';
        $data = array('malwareFamily' => $malwareFamily);
        $options = array(
            'http' => array(
                'header'  => "Content-type: application/json\r\n",
                'method'  => 'POST',
                'content' => json_encode($data),
            ),
        );
        $context  = stream_context_create($options);
        $result = file_get_contents($url, false, $context);
        if ($result === FALSE) {
            die("Erreur lors de l'exécution du script.");
        }

        $response = json_decode($result, true);
        $_SESSION['pid'] = trim($response['pid']);
        $_SESSION['status'] = 'Récupération en cours';

        echo json_encode(['status' => $_SESSION['status']]);
        exit();
    }

    if (isset($_POST['checkStatus']) && isset($_SESSION['pid'])) {
        if (isProcessRunning($_SESSION['pid'])) {
            $_SESSION['status'] = 'Récupération en cours';
        } else {
            $_SESSION['status'] = 'Terminé';
            unset($_SESSION['pid']);
        }

        echo json_encode(['status' => $_SESSION['status']]);
        exit();
    }

    if (isset($_POST['fetch_csv'])) {
        $directory = "/var/www/html/csv";
        $csvFile = null;

        foreach (glob("{$directory}/*.csv") as $file) {
            $csvFile = $file;
            break;
        }

        if ($csvFile) {
            $columnsWanted = ['md5_hash', 'first_seen', 'last_seen', 'file_name', 'file_size', 'file_type_mime', 'file_type', 'reporter'];
            $output = [];

            if (($handle = fopen($csvFile, 'r')) !== FALSE) {
                $headers = fgetcsv($handle, 1000, ",");
                while (($data = fgetcsv($handle, 1000, ",")) !== FALSE) {
                    $rowData = [];
                    foreach ($columnsWanted as $column) {
                        $index = array_search($column, $headers);
                        if ($index !== false && isset($data[$index])) {
                            $rowData[$column] = $data[$index];
                        }
                    }
                    $output[] = $rowData;
                }
                fclose($handle);
            } else {
                $errorMsg = "Erreur lors de la lecture du fichier CSV.";
            }
        } else {
            $errorMsg = "Aucun fichier CSV trouvé.";
        }
    }
}

?>







<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Site Web</title>
    <link rel="stylesheet" href="styles.css?v=4.4">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.2/min/dropzone.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.2/min/dropzone.min.js"></script>

    <!-- Configuration de base de Dropzone -->
<script>
Dropzone.options.malwareUpload = {
  paramName: "file",
  maxFilesize: 15,
  url: "upload.php",
  acceptedFiles: ".exe,.dll,.bin,.py",
  dictDefaultMessage: "Déposez les fichiers ici pour les télécharger",
  init: function() {
    this.on("complete", function(file) {
      this.removeFile(file);
    });
    this.on("success", function(file, response) {
      // Mettre à jour l'élément HTML avec le message de succès
      document.getElementById('uploadStatus').innerHTML = "<p class='success'>Succès : " + response + "</p>";
    });
    this.on("error", function(file, response) {
      // Mettre à jour l'élément HTML avec le message d'erreur
      // Si la réponse du serveur est un objet, nous devons obtenir le message d'erreur
      var errorMessage = response;
      if(typeof response === 'object' && response.error) {
        errorMessage = response.error;
      }
      document.getElementById('uploadStatus').innerHTML = "<p class='error'>Erreur : " + errorMessage + "</p>";
    });
  }
};
</script>


    <script>
        $(document).ready(function() {
            $('#myForm').on('submit', function(e) {
                e.preventDefault();
                $.post('malware.php', { malwareFamily: $('[name="malwareFamily"]').val() }, function(data) {
                    $('#message').text(data.status);
                    $('#message').css('color', data.status === 'Terminé' ? 'green' : 'orange');
                    pollForCompletion();
                }, 'json');
            });

            // Initialiser le bouton comme désactivé
        $('#csvButton').prop('disabled', true);

        function pollForCompletion() {
            $.post('malware.php', { checkStatus: true }, function(data) {
            $('#message').text(data.status);
            $('#message').css('color', data.status === 'Terminé' ? 'green' : 'orange');
        if (data.status === 'Récupération en cours') {
            setTimeout(pollForCompletion, 5000);
        } else if (data.status === 'Terminé') {
            $('#csvButton').prop('disabled', false); // Activer le bouton quand le statut est "Terminé"
            }
        }, 'json');
    }


            $('.runMalware').click(function() {
                let rowData = $(this).closest('tr').find('td').map(function() {
                    return $(this).text();
                }).get();

                // Mettez ici votre futur action pour le bouton Execute.
                console.log(rowData);
            });

        });
    </script>
</head>

<body>

<div class="nav-bar">
    <ul>
        <li><a href="index.php"><i class="fas fa-home"></i> Home</a></li>
        <li><a href="http://<?= $_SERVER['SERVER_ADDR'] ?>:5601" target="_blank"><i class="fas fa-crosshairs"></i> Hunting</a></li>
        <li><a href="mittre.php"><i class="fas fa-book"></i> Mitre Att&ck</a></li>
        <li><a href="malware.php"><i class="fas fa-virus"></i> Malware</a></li>
        <li><a href="usecase.php"><i class="fas fa-lightbulb"></i> UseCase</a></li>
        <li><a href="sharing.php"><i class="fas fa-pencil-alt"></i> Sharing</a></li>
    </ul>
</div>


<div class="user-info-bar">
    <div class="avatar-info">
        <img src="<?= $avatar ?>" alt="Avatar">
        <button class="user-button">
            <span><?= $first_name ?> <?= $last_name ?></span>
            <div class="dropdown-content">
                <a href="#" id="settings-link">Paramètres</a>
                <a href="logout.php">Déconnexion</a>
            </div>
        </button>
    </div>
</div>

<div id="sidebar" class="sidebar">
    <!-- Sidebar content -->
</div>

<div class="content">
    <h1>Malware Downloader</h1>
    <form id="myForm" method="post">
        <input type="text" name="malwareFamily" placeholder="Enter Malware Family">
        <input type="submit" name="submit" value="Execute">
    </form>
    <p id="message"></p>

    <form method="POST" action="">
        <button type="submit" name="fetch_csv" id="csvButton" class="displaycsvcontent">Afficher le contenu du CSV</button>
    </form>


  <?php
    if (isset($output)) {
        echo "<table class='malwaretable'>";  // Ajout de la classe 'malwaretable' pour styliser le tableau
        echo "<tr>";
        foreach ($columnsWanted as $column) {
            echo "<th>{$column}</th>";
        }
        echo "<th>Execute</th>";  // Ajout de la colonne "Execute"
        echo "</tr>";

        foreach ($output as $rowData) {
            echo "<tr>";
            foreach ($rowData as $cell) {
                echo "<td>{$cell}</td>";
            }
            echo "<td><button class='runMalware'>Run malware</button></td>";  // Ajout de la classe 'runMalware' pour styliser le bouton
            echo "</tr>";
        }
        echo "</table>";
    }

    if (isset($errorMsg)) {
        echo "<p style='color:red;'>{$errorMsg}</p>";
    }
    ?>



<hr class="separation">




<h1>Malware Uploader</h1>

<form action="upload.php" class="dropzone" id="malwareUpload"></form>
<div id="uploadStatus"></div>

</div>


<script>

    $(document).ready(function() {
        $('#toggleCsvContent').click(function() {
            $('#csvContent').toggle();  // Afficher/Masquer le contenu du CSV
        });

        $('.runMalware').click(function() {
            let rowData = $(this).closest('tr').find('td').map(function() {
                return $(this).text();
            }).get();
            // Ici, rowData contient les données de la ligne.
            // Vous pouvez ensuite les utiliser pour déclencher l'exécution du malware ou tout autre action que vous voulez.
            console.log(rowData);
        });
    });



    document.addEventListener('DOMContentLoaded', function() {
        document.querySelector('#settings-link').addEventListener('click', function(e) {
            e.preventDefault();
            let sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
            e.stopPropagation();
        });

        document.addEventListener('click', function(e) {
            let sidebar = document.getElementById('sidebar');
            if (!sidebar.contains(e.target) && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
    });
</script>
</body>
</html>
