import subprocess
import sys
import os

def execute_virtualbox_command(file_name):
    file_path = f"C:\\Users\\oem\\Documents\\malware_upload\\{file_name}"
    extension = os.path.splitext(file_name)[1].lower()

    # Initialisation de la commande pour chaque type d'extension
    if extension in ['.exe', '.dll', '.bin']:
        command = [
            "VBoxManage",
            "guestcontrol",
            "sandbox",
            "run",
            "--exe",
            file_path,
            "--username",
            "oem",
            "--password",
            "oem",
            "--"
        ]
    elif extension == '.py':
        # Initialisation de la commande pour les fichiers Python
        command = [
            "VBoxManage",
            "guestcontrol",
            "sandbox",
            "run",
            "--exe",
            "C:\\Python39\\python.exe",
            "--",
            file_path,
            "--username",
            "oem",
            "--password",
            "oem",
            "--"
        ]
    elif extension == '.ps1':
        # Construction de la commande PowerShell
        ps_command = f"& {{Start-Process powershell -ArgumentList '-ExecutionPolicy Bypass -File {file_path}' -Verb RunAs}}"
        # Initialisation de la commande pour les scripts PowerShell
        command = [
            "VBoxManage",
            "guestcontrol",
            "sandbox",
            "run",
            "--exe",
            "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe",
            "--username",
            "oem",
            "--password",
            "oem",
            "--",
            "-Command",
            ps_command
        ]

    else:
        print(f"Extension de fichier non prise en charge : {extension}", file=sys.stderr)
        return

    try:
        subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        print(f"Commande exécutée pour le fichier {file_name}")
    except Exception as e:
        print(f"Une erreur inattendue est survenue : {e}", file=sys.stderr)

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python sample_executable.py <file_name>", file=sys.stderr)
        sys.exit(1)

    file_name = sys.argv[1]
    execute_virtualbox_command(file_name)
